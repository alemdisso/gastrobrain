# Integration Test Logging & Flaky Test Detection

This directory contains tools for capturing and analyzing integration test output to detect intermittent/flaky test failures.

## ğŸ¯ Purpose

Intermittent test failures are hard to debug when they pass locally. These tools help:
1. **Capture test output** from multiple runs
2. **Analyze patterns** in failures
3. **Identify root causes** based on data, not speculation

## ğŸš€ Quick Start

### Local Testing (Windows)

**Stress test specific flaky tests:**
```powershell
# Uses test_configs/flaky_tests.txt
.\scripts\stress_test_integration.ps1 -Iterations 50 -TestsFile "test_configs\flaky_tests.txt"
```

**Run full suite overnight (with emulator protection):**
```powershell
.\scripts\stress_test_integration.ps1 -Iterations 20
```

**Analyze the captured logs:**
```powershell
dart scripts\analyze_test_logs.dart test_logs\stress_20260211_143022
```

### Local Testing (Linux/Mac)

Run tests 20 times:
```bash
bash scripts/run_integration_tests_with_logging.sh 20
```

Analyze logs:
```bash
dart scripts/analyze_test_logs.dart test_logs/integration_20260211_143022
```

### CI Testing (GitHub Actions)

1. Go to **Actions** tab in GitHub
2. Select **"Detect Flaky Integration Tests"** workflow
3. Click **"Run workflow"**
4. Configure:
   - **Iterations:** How many times to run (default: 20)
   - **Specific test:** Leave blank for all tests, or specify a file like `e2e_meal_editing_fields_test.dart`
5. Wait for completion
6. Download **integration-test-logs** artifact
7. Extract and analyze locally:
   ```bash
   dart scripts/analyze_test_logs.dart integration_ci_20260211_143022
   ```

## ğŸ“Š What the Analyzer Reports

The log analyzer (`analyze_test_logs.dart`) provides:

### 1. Run Summary
- Total runs, passed, failed counts
- Overall pass/fail rate

### 2. Failure Analysis (per test)
- Which tests failed
- How often each test failed
- Which runs had failures
- Consistent vs. varying error messages

### 3. Pattern Analysis
- **Consecutive failures:** Tests that fail multiple times in a row
- **Co-failures:** Tests that tend to fail together
- **Distribution:** When failures start/stop occurring

## ğŸ¯ Targeting Specific Tests

Instead of running the full suite, you can test only specific files using a config file:

### Create a Test List File

Create a file in `test_configs/` (e.g., `my_flaky_tests.txt`):

```text
# Comments start with #
# Paths relative to integration_test/

e2e/e2e_meal_editing_fields_test.dart
e2e/e2e_recipe_editing_workflow_test.dart
services/recommendation_service_test.dart
```

### Run the Tests

```powershell
.\scripts\stress_test_integration.ps1 -Iterations 50 -TestsFile "test_configs\my_flaky_tests.txt"
```

### Benefits

- **Faster:** Only test suspected flaky tests (~10min vs 30min per run)
- **More iterations:** Can run 50+ times in the same timeframe
- **Better signal:** More data on specific tests = clearer patterns

### Example: Issues #289 and #290

A pre-configured list exists for the current flaky tests:

```powershell
# Run the known flaky tests 50 times
.\scripts\stress_test_integration.ps1 -Iterations 50 -TestsFile "test_configs\flaky_tests.txt"
```

## ğŸ“ Output Structure

```
test_logs/
â””â”€â”€ integration_20260211_143022/
    â”œâ”€â”€ run_1_143022.log       # Individual test run logs
    â”œâ”€â”€ run_2_143045.log
    â”œâ”€â”€ ...
    â”œâ”€â”€ run_20_144532.log
    â”œâ”€â”€ summary.txt            # Quick pass/fail list
    â””â”€â”€ analysis_report.txt    # Generated by analyzer
```

## ğŸ” Example Analysis Output

```
================================================================================
TEST RUN SUMMARY
================================================================================
Total runs:  20
Passed:      18 (90.0%)
Failed:      2 (10.0%)

================================================================================
FAILURE ANALYSIS
================================================================================

ğŸ”´ Test: Notes field: handle special characters
   File: integration_test/e2e/e2e_meal_editing_fields_test.dart
   Failures: 2/20 runs (10.0%)
   Failed on runs: 7, 14

   Error:
   Expected: Special chars with emoji and quotes
   Actual: Basic notes

   â„¹ï¸  Error message is CONSISTENT across all failures

================================================================================
PATTERN ANALYSIS
================================================================================

ğŸ” Checking for consecutive failure patterns...
   âœ“ No consecutive failures detected

ğŸ” Checking for tests that fail together...
   âœ“ No consistent pattern of tests failing together

ğŸ” Failure distribution...
   First failure: Run 7
   Last failure: Run 14
   Spread: 7 runs
```

## ğŸ¯ Using Results to Fix Tests

Once you have 5-10 failure captures:

1. **Review error consistency:**
   - Same error every time â†’ Likely timing/race condition
   - Different errors â†’ Likely environmental or state pollution

2. **Check failure patterns:**
   - Consecutive failures â†’ May be test order dependent
   - Random failures â†’ Likely true race condition
   - Tests failing together â†’ Shared state issues

3. **Examine timing:**
   - Early run failures â†’ Setup/teardown issues
   - Late run failures â†’ Resource exhaustion

4. **Implement targeted fix:**
   - Add `pumpAndSettle()` for timing issues
   - Add cleanup for state pollution
   - Add retries for network/CI issues
   - Fix root cause in production code

## ğŸ”§ Related Issues

- #289 - Intermittent meal editing special characters test
- #290 - Intermittent recipe name editing test

## ğŸ’¡ Tips

- **Start with 20 runs** - Good balance of coverage vs. time
- **Run in CI** - Failures may be environment-specific
- **Test one file at a time** - Easier to identify patterns
- **Keep logs** - 30-day retention in CI artifacts
- **Document patterns** - Add findings to issue comments

## ğŸ›¡ï¸ Emulator Protection (New in stress_test_integration.ps1)

The enhanced stress test script includes automatic emulator health monitoring:

### Features

1. **Health Checks:** Verifies emulator is responsive before each run
2. **Auto-Restart:** Restarts ADB services if emulator becomes unresponsive
3. **Proactive Restarts:** Optionally restart every N runs to prevent crashes
4. **Crash Detection:** Identifies emulator crashes in logs

### Parameters

```powershell
# Restart emulator services every 5 runs (default)
-RestartEmulatorEvery 5

# Never restart (not recommended for overnight runs)
-RestartEmulatorEvery 0

# Skip health checks (faster but risky)
-SkipEmulatorCheck
```

### Why This Matters

Based on our analysis, the emulator crashes after ~60 minutes of continuous testing. Proactive restarts prevent this:

- **Without restarts:** 4 passes, then 16 consecutive failures (80% fail rate)
- **With restarts:** Maintains stability throughout 20+ hour runs

### Recommended for Overnight Runs

```powershell
# Full suite overnight with protection
.\scripts\stress_test_integration.ps1 -Iterations 20 -RestartEmulatorEvery 3
```

## âš™ï¸ Advanced Usage

### Run specific test file only

PowerShell:
```powershell
# Modify the script to target specific file
flutter test integration_test/e2e/e2e_meal_editing_fields_test.dart --reporter=expanded
```

CI Workflow:
```
Specific test: e2e/e2e_meal_editing_fields_test.dart
```

### Increase verbosity

Add `--verbose` flag in the run scripts for more detailed output.

### Custom analysis

The `TestLogAnalyzer` class in `analyze_test_logs.dart` can be extended with custom pattern detection logic.

## ğŸ“š Related Documentation

- [Dialog Testing Guide](../docs/testing/DIALOG_TESTING_GUIDE.md)
- [Edge Case Testing Guide](../docs/testing/EDGE_CASE_TESTING_GUIDE.md)
- [Mock Database Error Simulation](../docs/testing/MOCK_DATABASE_ERROR_SIMULATION.md)
